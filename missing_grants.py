import requests
import time
import sys
import os
import json

## [resource_id, profile_id, permission_level_id, permission_type_id]
grant_list = [
  [255284466914859,247422596505224,246996234271275,246530842202790],
  [255284466914859,247689888078239,246996234271275,246530842202790],
  [255284466914859,247696313859604,246996234271275,246530842106489],
  [255284466914859,247770228301092,246996234271275,246530842202790],
  [255284466914859,247770440455506,246996234271275,246530842137224],
  [255284466914859,248053772984962,246996234271275,246530842106489],
  [255284466914859,248053776023371,246996234271275,246530842106489],
  [255284466914859,248053858488304,246996234271275,246530842106489],
  [255284466914859,248053864787077,246996234271275,246530842071658],
  [255284466914859,248053866508516,246996234271275,246530842071658],
  [255284466914859,248053871939212,246996234271275,246530842071658],
  [255284466914859,248053875354616,246996234271275,246530842106489],
  [255284466914859,248053876348010,246996234271275,246530842106489],
  [255284466914859,248053876348010,246996234271275,246530842202790],
  [255284466914859,248053879050572,246996234271275,246530842071658],
  [255284466914859,248053880372711,246996234271275,246530842071658],
  [255284466914859,248053883525929,246996234271275,246530842106489],
  [255284466914859,248053885440966,246996234271275,246530842202790],
  [255284466914859,248053886029831,246996234271275,246530842106489],
  [255284466914859,248053886603300,246996234271275,246530842071658],
  [255284466914859,248053890770315,246996234271275,246530842106489],
  [255284466914859,248053896156045,246996234271275,246530842071658],
  [255284466914859,248053896649663,246996234271275,246530842071658],
  [255284466914859,248053900540178,246996234271275,246530842071658],
  [255284466914859,248053903014395,246996234271275,246530842202790],
  [255284466914859,248053904070256,246996234271275,246530842202790],
  [255284466914859,248053905235678,246996234271275,246530842071658],
  [255284466914859,248053909276763,246996234271275,246530842071658],
  [255284466914859,248053911366854,246996234271275,246530842106489],
  [255284466914859,248053912511853,246996234271275,246530842106489],
  [255284466914859,248053921683629,246996234271275,246530842106489],
  [255284466914859,248053922213070,246996234271275,246530842137224],
  [255284466914859,248053923172673,246996234271275,246530842202790],
  [255284466914859,248053924425088,246996234271275,246530842106489],
  [255284466914859,248053924425088,246996234271275,246530842137224],
  [255284466914859,248053925239239,246996234271275,246530842071658],
  [255284466914859,248053927800560,246996234271275,246530842071658],
  [255284466914859,248053935720941,246996234271275,246530842071658],
  [255284466914859,248053935720941,246996234271275,246530842167959],
  [255284466914859,248053940736922,246996234271275,246530842071658],
  [255284466914859,248053943618708,246996234271275,246530842106489],
  [255284466914859,248053948201488,246996234271275,246530842071658],
  [255284466914859,248053950011080,246996234271275,246530842106489],
  [255284466914859,248053950543592,246996234271275,246530842202790],
  [255284466914859,248053952319363,246996234271275,246530842106489],
  [255284466914859,248053953413097,246996234271275,246530842106489],
  [255284466914859,248053954039846,246996234271275,246530842137224],
  [255284466914859,248053954725998,246996234271275,246530842202790],
  [255284466914859,248053955307664,246996234271275,246530842071658],
  [255284466914859,248053958613426,246996234271275,246530842071658],
  [255284466914859,248053959267790,246996234271275,246530842304199],
  [255284466914859,248053961183880,246996234271275,246530842106489],
  [255284466914859,248053961183880,246996234271275,246530842202790],
  [255284466914859,248053963433793,246996234271275,246530842071658],
  [255284466914859,248053964528552,246996234271275,246530842106489],
  [255284466914859,248053965098957,246996234271275,246530842106489],
  [255284466914859,248053967902910,246996234271275,246530842106489],
  [255284466914859,248053967902910,246996234271275,246530842202790],
  [255284466914859,248053970359675,246996234271275,246530842106489],
  [255284466914859,248053971698197,246996234271275,246530842106489],
  [255284466914859,248053972311615,246996234271275,246530842071658],
  [255284466914859,248053974137574,246996234271275,246530842106489],
  [255284466914859,248053974137574,246996234271275,246530842137224],
  [255284466914859,248053978968233,246996234271275,246530842071658],
  [255284466914859,248053986220651,246996234271275,246530842202790],
  [255284466914859,248053995870493,246996234271275,246530842106489],
  [255284466914859,248054001163888,246996234271275,246530842071658],
  [255284466914859,248054003188442,246996234271275,246530842071658],
  [255284466914859,248054003965686,246996234271275,246530842106489],
  [255284466914859,248054008132633,246996234271275,246530842106489],
  [255284466914859,248054012059968,246996234271275,246530842071658],
  [255284466914859,248054012715372,246996234271275,246530842202790],
  [255284466914859,248054015113744,246996234271275,246530842071658],
  [255284466914859,248054016847492,246996234271275,246530842071658],
  [255284466914859,248054017460917,246996234271275,246530842106489],
  [255284466914859,248054026188039,246996234271275,246530842071658],
  [255284466914859,248054026188039,246996234271275,246530842106489],
  [255284466914859,248054027097425,246996234271275,246530842106489],
  [255284466914859,248054029636083,246996234271275,246530842071658],
  [255284466914859,248054029636083,246996234271275,246530842106489],
  [255284466914859,248054031581816,246996234271275,246530842137224],
  [255284466914859,248054032284354,246996234271275,246530842071658],
  [255284466914859,248054035526518,246996234271275,246530842202790],
  [255284466914859,248054043434403,246996234271275,246530842106489],
  [255284466914859,248054044868093,246996234271275,246530842202790],
  [255284466914859,248054046481002,246996234271275,246530842202790],
  [255284466914859,248054049586979,246996234271275,246530842071658],
  [255284466914859,248054050375531,246996234271275,246530842071658],
  [255284466914859,248054054525066,246996234271275,246530842202790],
  [255284466914859,248054055195827,246996234271275,246530842071658],
  [255284466914859,248054055195827,246996234271275,246530842106489],
  [255284466914859,248054066477931,246996234271275,246530842071658],
  [255284466914859,248054076086772,246996234271275,246530842071658],
  [255284466914859,248054076844573,246996234271275,246530842202790],
  [255284466914859,248054078816977,246996234271275,246530842106489],
  [255284466914859,248054081024818,246996234271275,246530842202790],
  [255284466914859,248054081024818,246996234271275,246530842239669],
  [255284466914859,248054083304395,246996234271275,246530842071658],
  [255284466914859,248054085573730,246996234271275,246530842071658],
  [255284466914859,248054085573730,246996234271275,246530842106489],
  [255284466914859,248054085573730,246996234271275,246530842202790],
  [255284466914859,248054087011547,246996234271275,246530842106489],
  [255284466914859,248054089069916,246996234271275,246530842071658],
  [255284466914859,248054089069916,246996234271275,246530842106489],
  [255284466914859,248054091860542,246996234271275,246530842071658],
  [255284466914859,248054093649623,246996234271275,246530842071658],
  [255284466914859,248054094418706,246996234271275,246530842071658],
  [255284466914859,248054096621510,246996234271275,246530842202790],
  [255284466914859,248054098836565,246996234271275,246530842071658],
  [255284466914859,248054106230412,246996234271275,246530842071658],
  [255284466914859,248054111672297,246996234271275,246530842071658],
  [255284466914859,248054113100885,246996234271275,246530842106489],
  [255284466914859,248054113788064,246996234271275,246530842071658],
  [255284466914859,248054115162385,246996234271275,246530842106489],
  [255284466914859,248054119858799,246996234271275,246530842071658],
  [255284466914859,248054120491697,246996234271275,246530842071658],
  [255284466914859,248054126092302,246996234271275,246530842202790],
  [255284466914859,248054126818353,246996234271275,246530842071658],
  [255284466914859,248054134169244,246996234271275,246530842071658],
  [255284466914859,248054135433990,246996234271275,246530842106489],
  [255284466914859,248054139826155,246996234271275,246530842106489],
  [255284466914859,248054147200553,246996234271275,246530842071658],
  [255284466914859,248054148565648,246996234271275,246530842071658],
  [255284466914859,248054149749502,246996234271275,246530842071658],
  [255284466914859,248054151105372,246996234271275,246530842202790],
  [255284466914859,248054154274880,246996234271275,246530842071658],
  [255284466914859,248054154274880,246996234271275,246530842106489],
  [255284466914859,248054157665554,246996234271275,246530842106489],
  [255284466914859,248054159408539,246996234271275,246530842106489],
  [255284466914859,248054161077766,246996234271275,246530842071658],
  [255284466914859,248054163125904,246996234271275,246530842071658],
  [255284466914859,248054169586843,246996234271275,246530842071658],
  [255284466914859,248054172277036,246996234271275,246530842167959],
  [255284466914859,248054174729649,246996234271275,246530842202790],
  [255284466914859,248054178389733,246996234271275,246530842071658],
  [255284466914859,248054178910991,246996234271275,246530842106489],
  [255284466914859,248054179853153,246996234271275,246530842071658],
  [255284466914859,248054186028424,246996234271275,246530842106489],
  [255284466914859,248054187348495,246996234271275,246530842071658],
  [255284466914859,248054188339798,246996234271275,246530842137224],
  [255284466914859,248054190367450,246996234271275,246530842304199],
  [255284466914859,248054191459188,246996234271275,246530842304199],
  [255284466914859,248054191956895,246996234271275,246530842202790],
  [255284466914859,248054194344066,246996234271275,246530842137224],
  [255284466914859,248054195472623,246996234271275,246530842137224],
  [255284466914859,248054198543852,246996234271275,246530842071658],
  [255284466914859,248054198543852,246996234271275,246530842106489],
  [255284466914859,248054199076371,246996234271275,246530842071658],
  [255284466914859,248054203170689,246996234271275,246530842071658],
  [255284466914859,248054208154961,246996234271275,246530842071658],
  [255284466914859,248054210011645,246996234271275,246530842071658],
  [255284466914859,248054211060311,246996234271275,246530842071658],
  [255284466914859,248054213438232,246996234271275,246530842071658],
  [255284466914859,248054214864762,246996234271275,246530842106489],
  [255284466914859,248054214864762,246996234271275,246530842202790],
  [255284466914859,248054223609497,246996234271275,246530842071658],
  [255284466914859,248054225486634,246996234271275,246530842202790],
  [255284466914859,248054233387426,246996234271275,246530842071658],
  [255284466914859,248054235673209,246996234271275,246530842071658],
  [255284466914859,248054235673209,246996234271275,246530842106489],
  [255284466914859,248054236816095,246996234271275,246530842106489],
  [255284466914859,248054243947786,246996234271275,246530842071658],
  [255284466914859,248054244476198,246996234271275,246530842137224],
  [255284466914859,248054247004637,246996234271275,246530842106489],
  [255284466914859,248054248278594,246996234271275,246530842071658],
  [255284466914859,248054249346720,246996234271275,246530842071658],
  [255284466914859,248054255052880,246996234271275,246530842071658],
  [255284466914859,248054261700180,246996234271275,246530842202790],
  [255284466914859,248054263412483,246996234271275,246530842202790],
  [255284466914859,248054274300535,246996234271275,246530842071658],
  [255284466914859,248054276207367,246996234271275,246530842106489],
  [255284466914859,248054281490615,246996234271275,246530842106489],
  [255284466914859,248054282111204,246996234271275,246530842106489],
  [255284466914859,248054285439436,246996234271275,246530842106489],
  [255284466914859,248054288044657,246996234271275,246530842202790],
  [255284466914859,248054288700088,246996234271275,246530842071658],
  [255284466914859,248054291521388,246996234271275,246530842071658],
  [255284466914859,248054291521388,246996234271275,246530842106489],
  [255284466914859,248054300444142,246996234271275,246530842071658],
  [255284466914859,248054305970065,246996234271275,246530842071658],
  [255284466914859,248054308198432,246996234271275,246530842071658],
  [255284466914859,248054311119055,246996234271275,246530842071658],
  [255284466914859,248054312952138,246996234271275,246530842071658],
  [255284466914859,248054314892771,246996234271275,246530842071658],
  [255284466914859,248054318086881,246996234271275,246530842106489],
  [255284466914859,248054318086881,246996234271275,246530842137224],
  [255284466914859,248054320849856,246996234271275,246530842137224],
  [255284466914859,248054321424364,246996234271275,246530842071658],
  [255284466914859,248054328269274,246996234271275,246530842202790],
  [255284466914859,248054328876562,246996234271275,246530842071658],
  [255284466914859,248054329526852,246996234271275,246530842071658],
  [255284466914859,248054331510469,246996234271275,246530842071658],
  [255284466914859,248066984850034,246996234271275,246530842071658],
  [255284466914859,248067005121514,246996234271275,246530842071658],
  [255284466914859,248067028003102,246996234271275,246530842106489],
  [255284466914859,248067028003102,246996234271275,246530842202790],
  [255284466914859,248067050450538,246996234271275,246530842071658],
  [255284466914859,248067077247001,246996234271275,246530842106489],
  [255284466914859,248067079404630,246996234271275,246530842071658],
  [255284466914859,248067109494351,246996234271275,246530842106489],
  [255284466914859,248690934365452,246996234271275,246530842071658],
  [255284466914859,248690997319455,246996234271275,246530842106489],
  [255284466914859,248691148074621,246996234271275,246530842106489],
  [255284466914859,248691192378458,246996234271275,246530842071658],
  [255284466914859,248691201915099,246996234271275,246530842071658],
  [255284466914859,248691240049359,246996234271275,246530842106489],
  [255284466914859,249337051917942,246996234271275,246530842071658],
  [255284466914859,249337325817501,246996234271275,246530842071658],
  [255284466914859,250130361445510,246996234271275,246530842106489],
  [255284466914859,250130394574254,246996234271275,246530842071658],
  [255284466914859,250130432738259,246996234271275,246530842137224],
  [255284466914859,250130432738259,246996234271275,246530842202790],
  [255284466914859,250130475892425,246996234271275,246530842071658],
  [255284466914859,250130475892425,246996234271275,246530842137224],
  [255284466914859,250259311292944,246996234271275,246530842071658],
  [255284466914859,251313350199390,246996234271275,246530842106489],
  [255284466914859,251419791269646,246996234271275,246530842106489],
  [255284466914859,251494938289224,246996234271275,246530842071658],
  [255284466914859,251494940672290,246996234271275,246530842137224],
  [255284466914859,251494946191734,246996234271275,246530842071658],
  [255284466914859,251494951013927,246996234271275,246530842071658],
  [255284466914859,251494955917921,246996234271275,246530842137224],
  [255284466914859,251494955917921,246996234271275,246530842202790],
  [255284466914859,251494959466458,246996234271275,246530842071658],
  [255284466914859,253238333034864,246996234271275,246530842137224],
  [255284466914859,253597648097300,246996234271275,246530842137224],
  [255284466914859,253599152010721,246996234271275,246530842137224],
  [255284466914859,255247558062550,246996234271275,246530842071658],
  [255284466914859,255247561058924,246996234271275,246530842071658],
  [255284466914859,255247561973384,246996234271275,246530842071658],
  [255284466914859,255805915413033,246996234271275,246530842071658],
  [255284466914859,257508737070205,246996234271275,246530842071658],
  [255284466914859,257686085572903,246996234271275,246530842071658],
  [255284466914859,258637327941206,246996234271275,246530842071658],
  [255284466914859,259343086475003,246996234271275,246530842071658],
  [255284466914859,259433456625492,246996234271275,246530842071658],
  [255284466914859,259433456625492,246996234271275,246530842106489],
  [255284466914859,259434137981343,246996234271275,246530842071658],
  [255284466914859,259434137981343,246996234271275,246530842106489],
  [255284466914859,260437501275616,246996234271275,246530842071658],
  [255284466914859,260520996696523,246996234271275,246530842071658],
  [255284466914859,260585408339284,246996234271275,246530842071658],
  [255284466914859,260767732085236,246996234271275,246530842071658],
  [255284466914859,261286817639199,246996234271275,246530842071658],
  [255284466914859,261734564943212,246996234271275,246530842071658],
  [255284466914859,263066279159663,246996234271275,246530842071658],
  [255284466914859,263072352149170,246996234271275,246530842071658],
  [255284466914859,264287943238084,246996234271275,246530842071658],
  [255284466914859,264948784960843,246996234271275,246530842071658],
  [255284466914859,265034797742257,246996234271275,246530842071658]
]


class GraphQlException(Exception):
    def __init__(self, *args: object) -> None:
        super().__init__(*args)


class GraphQl:
    def __init__(self, endpoint: str, access_key: str, secret_access_key: str) -> None:
        if not endpoint or type(endpoint) is not str:
            raise ValueError("endpoint is missing or not string type")

        if not access_key or type(access_key) is not str:
            raise ValueError("access_key is missing or not string type")

        if not secret_access_key or type(secret_access_key) is not str:
            raise ValueError("secret_access_key is missing or not string type")

        self.__endpoint = endpoint
        self.__access_key = access_key
        self.__secret_access_key = secret_access_key

    def get_endpoint(self) -> str:
        return self.__endpoint

    def get_access_key(self) -> str:
        return self.__access_key

    def get_secret_access_key(self) -> str:
        return self.__secret_access_key

    def run_query(self, query: str, variables: dict) -> dict:
        if not query or type(query) is not str:
            raise ValueError("query is missing or not string type")

        if not variables or type(variables) is not dict:
            raise ValueError("variables is missing or not dict type")

        print(f"Query: {query}")
        print(f"Variables: {variables}")

        response = requests.post(
            self.get_endpoint(),
            auth=(self.get_access_key(), self.get_secret_access_key()),
            json={'query': query, 'variables': variables}
        )

        return response


def get_activate_grant_mutation():
  return '''
    mutation ActivateGrant($input1: ActivateGrantInput!) {
      activateGrant1: activateGrant(input: $input1) {
        turbot {
          id
          __typename
        }
        __typename
      }
    }
'''

def get_activate_grant_variables(grant_id, resource_id):
  return {
    "input1": {
      "grant": grant_id,
      "resource": str(resource_id)
    }
  }

def get_create_grant_mutation():
  return '''
    mutation CreateGrants($input1: CreateGrantInput!) {
    createGrant1: createGrant(input: $input1) {
      turbot {
        id
        __typename
      }
      __typename
    }
  }
'''

def get_create_grant_variables(resource_id, profile_id, permission_level, permission_type):
  return {
    "input1": {
      "type": str(permission_type),
      "level": str(permission_level),
      "resource": str(resource_id),
      "roleName": None,
      "validToTimestamp": None,
      "identity": str(profile_id)
    }
  }

graphql_endpoint = "https://console.prod.amazon.biogen.com/api/v5/graphql"
turbot_access_key = "e90202aa-a152-452b-96e4-f84d57c2a2d8"
turbot_secret_access_key = "b4f4bd85-bd78-421e-88ad-69921769e8f5"
graph_ql = GraphQl(graphql_endpoint, turbot_access_key, turbot_secret_access_key)
create_grant_mutation = get_create_grant_mutation()
activate_grant_mutation = get_activate_grant_mutation()

max = len(grant_list)
start = 0
batch_size = 50
batches = 6
wait = 30

for b in range(batches):
  print(f"Starting Batch {b}")
  start = b * batch_size
  end = start + batch_size
  if start < max:
    if end > max:
      end = max
    for i in range(start,end):
      print(f"Starting record: {i}")
      grant = grant_list[i]
      create_grant_vars = get_create_grant_variables(grant[0], grant[1], grant[2], grant[3])
      response = graph_ql.run_query(create_grant_mutation, create_grant_vars)

      if response.status_code != 200 or response.json().get("errors"):
        print("Create Error: {}".format(response.text))
        print("CreateErrData: {},{},{},{}".format(grant[0], grant[1], grant[2], grant[3]))
        continue

      response = response.json()

      grant_id = response.get('data').get('createGrant1').get('turbot').get('id')
      if grant_id:
        activate_grant_vars = get_activate_grant_variables(grant_id, grant[0])
        response = graph_ql.run_query(activate_grant_mutation, activate_grant_vars)
        if response.status_code != 200 or response.json().get("errors"):
          print("Activate Error: {}".format(response.text))
          print("ActvateErrData: GrantId:{} ResourceId:{}".format(grant_id, grant[0]))

  print(f"Pausing Execution for {wait} seconds")
  time.sleep(wait)
